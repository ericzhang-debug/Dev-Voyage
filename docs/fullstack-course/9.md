---
title: ç¬¬ 9 ç« ï¼šç”¨æˆ·ç™»å½•æ³¨å†Œ
createTime: 2025/12/19 12:00:00
permalink: /fullstack-course/user-auth/
---
# ç¬¬ 9 ç« ï¼šç”¨æˆ·ç™»å½•æ³¨å†Œ

::: important æœ¬ç« å­¦ä¹ ç›®æ ‡
- è®¾è®¡ç”¨æˆ·æ•°æ®è¡¨
- ç†è§£å¯†ç å®‰å…¨ä¸å“ˆå¸Œ
- å­¦ä¹  JWT è®¤è¯æœºåˆ¶
- å®ç°æ³¨å†Œå’Œç™»å½•åŠŸèƒ½
- ğŸ‰ **æˆæœï¼šç”¨æˆ·ç³»ç»Ÿä¸Šçº¿ï¼**
:::

æ–‡ç« å¯ä»¥å‘å¸ƒäº†ï¼Œä½†ç°åœ¨**è°éƒ½èƒ½å‘**â€”â€”ä½ çš„åšå®¢å¯èƒ½è¢«é™Œç”Ÿäººå‘æ»¡å¹¿å‘Šï¼è¿™ä¸€ç« æˆ‘ä»¬æ¥å®ç°ç”¨æˆ·ç³»ç»Ÿï¼Œè®©åªæœ‰æ³¨å†Œç™»å½•çš„ç”¨æˆ·æ‰èƒ½å‘æ–‡ç« ã€‚

::: tip æœ¬ç« ç»“æŸåä½ ä¼šå¾—åˆ°ä»€ä¹ˆ
ä¸€ä¸ªå®Œæ•´çš„ç”¨æˆ·è®¤è¯ç³»ç»Ÿâ€”â€”æ³¨å†Œã€ç™»å½•ã€è®°ä½ç™»å½•çŠ¶æ€ï¼Œå¹¶ä¸”åªæœ‰ç™»å½•åæ‰èƒ½å‘å¸ƒæ–‡ç« ï¼
:::

## 9.1 ä¸ºä»€ä¹ˆéœ€è¦ç”¨æˆ·ç³»ç»Ÿ

### 9.1.1 å½“å‰ç³»ç»Ÿçš„é—®é¢˜

ç›®å‰æˆ‘ä»¬çš„åšå®¢ï¼š
- âŒ ä»»ä½•äººéƒ½èƒ½å‘å¸ƒæ–‡ç« 
- âŒ æ— æ³•åŒºåˆ†æ–‡ç« æ˜¯è°å†™çš„
- âŒ æ²¡æœ‰ä¸ªäººä¸­å¿ƒ
- âŒ æ— æ³•ç®¡ç†è‡ªå·±çš„æ–‡ç« 

### 9.1.2 è®¤è¯ vs æˆæƒ

åœ¨å®ç°ç”¨æˆ·ç³»ç»Ÿä¹‹å‰ï¼Œå…ˆç†è§£ä¸¤ä¸ªæ¦‚å¿µï¼š

| æ¦‚å¿µ | è‹±æ–‡ | é—®é¢˜ | ä¾‹å­ |
|------|------|------|------|
| **è®¤è¯** | Authentication | ä½ æ˜¯è°ï¼Ÿ | ç™»å½•éªŒè¯ç”¨æˆ·åå¯†ç  |
| **æˆæƒ** | Authorization | ä½ èƒ½å¹²ä»€ä¹ˆï¼Ÿ | åªæœ‰ä½œè€…èƒ½ç¼–è¾‘è‡ªå·±çš„æ–‡ç«  |

::: tip ç®€å•è®°å¿†
- **è®¤è¯**ï¼šéªŒè¯èº«ä»½ï¼ˆæ˜¯ä¸æ˜¯è¿™ä¸ªäººï¼‰
- **æˆæƒ**ï¼šæ£€æŸ¥æƒé™ï¼ˆè¿™ä¸ªäººèƒ½ä¸èƒ½åšè¿™ä»¶äº‹ï¼‰

æœ¬ç« é‡ç‚¹æ˜¯**è®¤è¯**ï¼Œç¬¬ 10 ç« ä¼šæ¶‰åŠ**æˆæƒ**ã€‚
:::

## 9.2 ç”¨æˆ·æ•°æ®åº“è®¾è®¡

### 9.2.1 ç”¨æˆ·è¡¨å­—æ®µè®¾è®¡

ä¸€ä¸ªç”¨æˆ·éœ€è¦å“ªäº›ä¿¡æ¯ï¼Ÿ

| å­—æ®µ | ç±»å‹ | è¯´æ˜ |
|------|------|------|
| `id` | INTEGER | ä¸»é”® |
| `username` | STRING | ç”¨æˆ·åï¼ˆå”¯ä¸€ï¼‰ |
| `email` | STRING | é‚®ç®±ï¼ˆå”¯ä¸€ï¼‰ |
| `hashed_password` | STRING | åŠ å¯†åçš„å¯†ç  |
| `created_at` | STRING | æ³¨å†Œæ—¶é—´ |
| `avatar` | STRING | å¤´åƒ URLï¼ˆå¯é€‰ï¼‰ |

::: warning ä¸ºä»€ä¹ˆæ˜¯ hashed_password è€Œä¸æ˜¯ passwordï¼Ÿ
**æ°¸è¿œä¸è¦æ˜æ–‡å­˜å‚¨å¯†ç ï¼**

å¦‚æœæ•°æ®åº“æ³„éœ²ï¼Œæ˜æ–‡å¯†ç ä¼šè®©æ‰€æœ‰ç”¨æˆ·çš„è´¦å·éƒ½å¤„äºå±é™©ä¸­ã€‚æˆ‘ä»¬éœ€è¦æŠŠå¯†ç "åŠ å¯†"åå†å­˜å‚¨ã€‚
:::

### 9.2.2 å¯†ç å®‰å…¨ï¼šä¸ºä»€ä¹ˆè¦å“ˆå¸Œ

::: info å†å²è¶£äº‹ï¼šå¯†ç æ³„éœ²äº‹ä»¶
2012 å¹´ï¼ŒLinkedIn è¢«é»‘å®¢æ”»å‡»ï¼Œ650 ä¸‡ç”¨æˆ·å¯†ç æ³„éœ²ã€‚ç”±äº LinkedIn å½“æ—¶ä½¿ç”¨çš„æ˜¯ä¸å®‰å…¨çš„ SHA-1 å“ˆå¸Œï¼ˆæ²¡æœ‰åŠ ç›ï¼‰ï¼Œé»‘å®¢å¾ˆå¿«å°±ç ´è§£äº†å¤§é‡å¯†ç ã€‚

2016 å¹´ï¼Œè¿™ä¸ªæ•°æ®åˆè¢«æ‰©å¤§åˆ° 1.17 äº¿æ¡ã€‚è®¸å¤šç”¨æˆ·å› ä¸ºåœ¨å¤šä¸ªç½‘ç«™ä½¿ç”¨ç›¸åŒå¯†ç ï¼Œå¯¼è‡´å…¶ä»–è´¦å·ä¹Ÿè¢«ç›—ã€‚

è¿™å°±æ˜¯ä¸ºä»€ä¹ˆå¯†ç å®‰å…¨å¦‚æ­¤é‡è¦ï¼
:::

**å¯†ç å­˜å‚¨çš„æ¼”è¿›**ï¼š

```
1. æ˜æ–‡å­˜å‚¨ âŒ
   password = "123456"
   â†’ æ•°æ®åº“æ³„éœ² = å¯†ç æ³„éœ²

2. ç®€å•å“ˆå¸Œ âŒ
   password = MD5("123456") = "e10adc3949ba59abbe56e057f20f883e"
   â†’ å½©è™¹è¡¨æ”»å‡»å¯ç ´è§£

3. åŠ ç›å“ˆå¸Œ âœ…
   password = bcrypt("123456" + éšæœºç›)
   â†’ æ¯ä¸ªå¯†ç éƒ½æœ‰ç‹¬ç‰¹çš„ç›ï¼Œæ— æ³•ç”¨å½©è™¹è¡¨
```

### 9.2.3 bcrypt ç®€ä»‹

::: info å†å²è¶£äº‹ï¼šbcrypt çš„è®¾è®¡å“²å­¦
bcrypt ç”± Niels Provos å’Œ David MaziÃ¨res åœ¨ 1999 å¹´è®¾è®¡ï¼ŒåŸºäº Blowfish åŠ å¯†ç®—æ³•ã€‚

å®ƒæœ‰ä¸€ä¸ªç‹¬ç‰¹çš„è®¾è®¡ï¼š**æ•…æ„å¾ˆæ…¢**ã€‚

ä¸ºä»€ä¹ˆè¦æ…¢ï¼Ÿå› ä¸ºéªŒè¯ä¸€æ¬¡å¯†ç å¯¹ç”¨æˆ·æ¥è¯´ 0.1 ç§’å’Œ 0.001 ç§’æ²¡åŒºåˆ«ï¼Œä½†å¯¹æš´åŠ›ç ´è§£çš„é»‘å®¢æ¥è¯´ï¼Œæ…¢ 100 å€æ„å‘³ç€ç ´è§£æ—¶é—´ä» 1 å¤©å˜æˆ 100 å¤©ï¼

è€Œä¸” bcrypt å¯ä»¥è°ƒæ•´"æ…¢çš„ç¨‹åº¦"ï¼ˆcost factorï¼‰ï¼Œéšç€è®¡ç®—æœºè¶Šæ¥è¶Šå¿«ï¼Œå¯ä»¥å¢åŠ  cost æ¥ä¿æŒå®‰å…¨ã€‚
:::

bcrypt çš„ç‰¹ç‚¹ï¼š
- âœ… è‡ªåŠ¨ç”Ÿæˆéšæœºç›
- âœ… å¯è°ƒèŠ‚çš„è®¡ç®—æˆæœ¬
- âœ… ä¸šç•Œæ ‡å‡†ï¼Œå¹¿æ³›ä½¿ç”¨

### 9.2.4 æ·»åŠ  User æ¨¡å‹

ä¿®æ”¹ `backend/src/backend/models.py`ï¼Œæ·»åŠ  User æ¨¡å‹ï¼š

```python
# backend/src/backend/models.py
from sqlalchemy import Column, Integer, String, Text, ForeignKey
from sqlalchemy.orm import relationship
from .database import Base


class User(Base):
    """ç”¨æˆ·æ¨¡å‹"""
    __tablename__ = "users"

    id = Column(Integer, primary_key=True, index=True)
    username = Column(String(50), unique=True, nullable=False, index=True)
    email = Column(String(100), unique=True, nullable=False, index=True)
    hashed_password = Column(String(200), nullable=False)
    created_at = Column(String(20))
    avatar = Column(String(500), default="")

    # å…³è”ï¼šä¸€ä¸ªç”¨æˆ·å¯ä»¥æœ‰å¤šç¯‡æ–‡ç« 
    articles = relationship("Article", back_populates="user")

    def to_dict(self):
        return {
            "id": self.id,
            "username": self.username,
            "email": self.email,
            "created_at": self.created_at,
            "avatar": self.avatar
        }


class Article(Base):
    """æ–‡ç« æ¨¡å‹ï¼ˆæ›´æ–°ç‰ˆï¼‰"""
    __tablename__ = "articles"

    id = Column(Integer, primary_key=True, index=True)
    title = Column(String(200), nullable=False)
    summary = Column(Text)
    content = Column(Text)
    author = Column(String(100), default="åšä¸»")
    created_at = Column(String(20))
    tags = Column(String(200))
    
    # æ–°å¢ï¼šå…³è”ç”¨æˆ·
    user_id = Column(Integer, ForeignKey("users.id"), nullable=True)
    user = relationship("User", back_populates="articles")

    def to_dict(self):
        return {
            "id": self.id,
            "title": self.title,
            "summary": self.summary,
            "content": self.content,
            "author": self.user.username if self.user else self.author,
            "created_at": self.created_at,
            "tags": self.tags.split(",") if self.tags else []
        }
```

::: note relationship æ˜¯ä»€ä¹ˆï¼Ÿ
`relationship` å®šä¹‰äº†æ¨¡å‹ä¹‹é—´çš„å…³è”å…³ç³»ã€‚è¿™é‡Œï¼š
- ä¸€ä¸ª User å¯ä»¥æœ‰å¤šä¸ª Articleï¼ˆä¸€å¯¹å¤šï¼‰
- `back_populates` è®©ä¸¤è¾¹éƒ½èƒ½è®¿é—®å¯¹æ–¹

è¿™æ ·æˆ‘ä»¬å¯ä»¥é€šè¿‡ `user.articles` è·å–ç”¨æˆ·çš„æ‰€æœ‰æ–‡ç« ï¼Œä¹Ÿå¯ä»¥é€šè¿‡ `article.user` è·å–æ–‡ç« çš„ä½œè€…ã€‚
:::

## 9.3 å®‰è£…è®¤è¯ç›¸å…³ä¾èµ–

åœ¨ `backend` ç›®å½•ä¸‹ï¼Œæˆ‘ä»¬éœ€è¦å®‰è£…ä¸¤ä¸ªåŒ…ï¼š

```bash
# åœ¨ backend ç›®å½•ä¸‹
pdm add python-jose[cryptography]  # JWT å¤„ç†
pdm add passlib[bcrypt]            # å¯†ç å“ˆå¸Œ
```

::: tip è¿™ä¸¤ä¸ªåŒ…æ˜¯å¹²ä»€ä¹ˆçš„ï¼Ÿ
- **python-jose**ï¼šå¤„ç† JWTï¼ˆJSON Web Tokenï¼‰ï¼Œç”¨äºç”Ÿæˆå’ŒéªŒè¯ç™»å½•å‡­è¯
- **passlib**ï¼šå¯†ç å“ˆå¸Œåº“ï¼Œæ”¯æŒ bcrypt ç­‰å¤šç§ç®—æ³•
:::

## 9.4 åˆ›å»ºè®¤è¯æ¨¡å—

### 9.4.1 åˆ›å»º auth.py

åœ¨ `backend/src/backend/` ç›®å½•ä¸‹åˆ›å»º `auth.py`ï¼š

```python
# backend/src/backend/auth.py
from datetime import datetime, timedelta
from typing import Optional
from jose import JWTError, jwt
from passlib.context import CryptContext
from fastapi import Depends, HTTPException, status
from fastapi.security import HTTPBearer, HTTPAuthorizationCredentials
from sqlalchemy.orm import Session
from .database import get_db
from .models import User

# å¯†ç å“ˆå¸Œé…ç½®
pwd_context = CryptContext(schemes=["bcrypt"], deprecated="auto")

# JWT é…ç½®
SECRET_KEY = "your-secret-key-change-this-in-production"  # ç”Ÿäº§ç¯å¢ƒè¦æ¢æˆéšæœºå­—ç¬¦ä¸²ï¼
ALGORITHM = "HS256"
ACCESS_TOKEN_EXPIRE_MINUTES = 60 * 24 * 7  # 7 å¤©

# Bearer Token è®¤è¯
security = HTTPBearer(auto_error=False)


def hash_password(password: str) -> str:
    """å¯¹å¯†ç è¿›è¡Œå“ˆå¸Œ"""
    return pwd_context.hash(password)


def verify_password(plain_password: str, hashed_password: str) -> bool:
    """éªŒè¯å¯†ç """
    return pwd_context.verify(plain_password, hashed_password)


def create_access_token(data: dict, expires_delta: Optional[timedelta] = None) -> str:
    """åˆ›å»º JWT Token"""
    to_encode = data.copy()
    if expires_delta:
        expire = datetime.utcnow() + expires_delta
    else:
        expire = datetime.utcnow() + timedelta(minutes=ACCESS_TOKEN_EXPIRE_MINUTES)
    to_encode.update({"exp": expire})
    encoded_jwt = jwt.encode(to_encode, SECRET_KEY, algorithm=ALGORITHM)
    return encoded_jwt


def decode_token(token: str) -> Optional[dict]:
    """è§£ç  JWT Token"""
    try:
        payload = jwt.decode(token, SECRET_KEY, algorithms=[ALGORITHM])
        return payload
    except JWTError:
        return None


async def get_current_user(
    credentials: HTTPAuthorizationCredentials = Depends(security),
    db: Session = Depends(get_db)
) -> Optional[User]:
    """è·å–å½“å‰ç™»å½•ç”¨æˆ·ï¼ˆå¯é€‰ï¼‰"""
    if not credentials:
        return None
    
    token = credentials.credentials
    payload = decode_token(token)
    if not payload:
        return None
    
    user_id = payload.get("sub")
    if not user_id:
        return None
    
    user = db.query(User).filter(User.id == int(user_id)).first()
    return user


async def get_current_user_required(
    credentials: HTTPAuthorizationCredentials = Depends(security),
    db: Session = Depends(get_db)
) -> User:
    """è·å–å½“å‰ç™»å½•ç”¨æˆ·ï¼ˆå¿…é¡»ç™»å½•ï¼‰"""
    if not credentials:
        raise HTTPException(
            status_code=status.HTTP_401_UNAUTHORIZED,
            detail="æœªç™»å½•",
            headers={"WWW-Authenticate": "Bearer"},
        )
    
    token = credentials.credentials
    payload = decode_token(token)
    if not payload:
        raise HTTPException(
            status_code=status.HTTP_401_UNAUTHORIZED,
            detail="Token æ— æ•ˆæˆ–å·²è¿‡æœŸ",
            headers={"WWW-Authenticate": "Bearer"},
        )
    
    user_id = payload.get("sub")
    if not user_id:
        raise HTTPException(
            status_code=status.HTTP_401_UNAUTHORIZED,
            detail="Token æ— æ•ˆ",
            headers={"WWW-Authenticate": "Bearer"},
        )
    
    user = db.query(User).filter(User.id == int(user_id)).first()
    if not user:
        raise HTTPException(
            status_code=status.HTTP_401_UNAUTHORIZED,
            detail="ç”¨æˆ·ä¸å­˜åœ¨",
            headers={"WWW-Authenticate": "Bearer"},
        )
    
    return user
```

::: warning SECRET_KEY å¾ˆé‡è¦ï¼
`SECRET_KEY` æ˜¯ç”¨æ¥ç­¾å JWT çš„å¯†é’¥ã€‚åœ¨ç”Ÿäº§ç¯å¢ƒä¸­ï¼š
- å¿…é¡»ä½¿ç”¨éšæœºç”Ÿæˆçš„é•¿å­—ç¬¦ä¸²
- ä¸è¦æäº¤åˆ°ä»£ç ä»“åº“
- å¯ä»¥ç”¨ç¯å¢ƒå˜é‡æ¥é…ç½®

ç¤ºä¾‹ï¼š`openssl rand -hex 32` å¯ä»¥ç”Ÿæˆä¸€ä¸ªå®‰å…¨çš„éšæœºå¯†é’¥ã€‚
:::

### 9.4.2 JWT æ˜¯ä»€ä¹ˆï¼Ÿ

::: info å†å²è¶£äº‹ï¼šSession åˆ° Token çš„æ¼”å˜
æ—©æœŸçš„ Web è®¤è¯ä½¿ç”¨ Sessionï¼šç”¨æˆ·ç™»å½•åï¼ŒæœåŠ¡å™¨ä¿å­˜ä¸€ä¸ª Session IDï¼Œæµè§ˆå™¨ç”¨ Cookie ä¿å­˜è¿™ä¸ª IDã€‚ä½†è¿™ç§æ–¹å¼æœ‰é—®é¢˜ï¼š
- æœåŠ¡å™¨è¦å­˜å‚¨å¤§é‡ Session æ•°æ®
- å¤šæœåŠ¡å™¨éƒ¨ç½²æ—¶ Session åŒæ­¥å›°éš¾
- ç§»åŠ¨ç«¯å’Œ API ä¸æ–¹ä¾¿ä½¿ç”¨ Cookie

2010 å¹´ä»£ï¼ŒJWTï¼ˆJSON Web Tokenï¼‰é€æ¸æµè¡Œã€‚å®ƒçš„æ€è·¯æ˜¯ï¼š**æŠŠç”¨æˆ·ä¿¡æ¯ç›´æ¥ç¼–ç åœ¨ Token é‡Œ**ï¼ŒæœåŠ¡å™¨åªéœ€è¦éªŒè¯ç­¾åï¼Œä¸ç”¨å­˜å‚¨ä»»ä½•ä¸œè¥¿ã€‚

2015 å¹´ï¼ŒJWT æˆä¸º RFC 7519 æ ‡å‡†ï¼Œå¦‚ä»Šå·²æ˜¯ API è®¤è¯çš„ä¸»æµæ–¹æ¡ˆã€‚
:::

**JWT çš„ç»“æ„**ï¼š

```
eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJzdWIiOiIxMjM0NTY3ODkwIiwibmFtZSI6IkpvaG4gRG9lIiwiaWF0IjoxNTE2MjM5MDIyfQ.SflKxwRJSMeKKF2QT4fwpMeJf36POk6yJV_adQssw5c
      â”‚                                    â”‚                                                                â”‚
   Header                               Payload                                                        Signature
  (ç®—æ³•ä¿¡æ¯)                           (ç”¨æˆ·æ•°æ®)                                                      (ç­¾åéªŒè¯)
```

ä¸‰éƒ¨åˆ†ç”¨ `.` åˆ†éš”ï¼š
1. **Header**ï¼šå£°æ˜ä½¿ç”¨çš„ç®—æ³•
2. **Payload**ï¼šå­˜å‚¨ç”¨æˆ· ID ç­‰ä¿¡æ¯
3. **Signature**ï¼šç”¨å¯†é’¥ç­¾åï¼Œé˜²æ­¢ç¯¡æ”¹

## 9.5 æ·»åŠ ç”¨æˆ·ç›¸å…³çš„ Schema

ä¿®æ”¹ `backend/src/backend/schemas.py`ï¼Œæ·»åŠ ç”¨æˆ·ç›¸å…³çš„æ¨¡å‹ï¼š

```python
# åœ¨ schemas.py ä¸­æ·»åŠ 

class UserCreate(BaseModel):
    """ç”¨æˆ·æ³¨å†Œæ¨¡å‹"""
    username: str = Field(..., min_length=3, max_length=50, description="ç”¨æˆ·å")
    email: str = Field(..., description="é‚®ç®±")
    password: str = Field(..., min_length=6, description="å¯†ç ")


class UserLogin(BaseModel):
    """ç”¨æˆ·ç™»å½•æ¨¡å‹"""
    username: str = Field(..., description="ç”¨æˆ·åæˆ–é‚®ç®±")
    password: str = Field(..., description="å¯†ç ")


class UserResponse(BaseModel):
    """ç”¨æˆ·ä¿¡æ¯å“åº”"""
    id: int
    username: str
    email: str
    created_at: str
    avatar: str


class TokenResponse(BaseModel):
    """ç™»å½•æˆåŠŸå“åº”"""
    access_token: str
    token_type: str = "bearer"
    user: UserResponse
```

## 9.6 å®ç°æ³¨å†Œå’Œç™»å½• API

ä¿®æ”¹ `backend/src/backend/__init__.py`ï¼Œæ·»åŠ ç”¨æˆ·ç›¸å…³çš„ APIï¼š

```python
# åœ¨æ–‡ä»¶é¡¶éƒ¨æ·»åŠ å¯¼å…¥
from .auth import (
    hash_password, 
    verify_password, 
    create_access_token,
    get_current_user,
    get_current_user_required
)
from .schemas import UserCreate, UserLogin, TokenResponse
from .models import User

# æ·»åŠ æ³¨å†Œ API
@app.post("/api/auth/register")
def register(user_data: UserCreate, db: Session = Depends(get_db)):
    """ç”¨æˆ·æ³¨å†Œ"""
    # æ£€æŸ¥ç”¨æˆ·åæ˜¯å¦å·²å­˜åœ¨
    if db.query(User).filter(User.username == user_data.username).first():
        raise HTTPException(status_code=400, detail="ç”¨æˆ·åå·²è¢«ä½¿ç”¨")
    
    # æ£€æŸ¥é‚®ç®±æ˜¯å¦å·²å­˜åœ¨
    if db.query(User).filter(User.email == user_data.email).first():
        raise HTTPException(status_code=400, detail="é‚®ç®±å·²è¢«æ³¨å†Œ")
    
    # åˆ›å»ºç”¨æˆ·
    user = User(
        username=user_data.username,
        email=user_data.email,
        hashed_password=hash_password(user_data.password),
        created_at=datetime.now().strftime("%Y-%m-%d")
    )
    db.add(user)
    db.commit()
    db.refresh(user)
    
    # ç”Ÿæˆ Token
    access_token = create_access_token(data={"sub": str(user.id)})
    
    return {
        "message": "æ³¨å†ŒæˆåŠŸ",
        "access_token": access_token,
        "token_type": "bearer",
        "user": user.to_dict()
    }


@app.post("/api/auth/login")
def login(login_data: UserLogin, db: Session = Depends(get_db)):
    """ç”¨æˆ·ç™»å½•"""
    # æ”¯æŒç”¨æˆ·åæˆ–é‚®ç®±ç™»å½•
    user = db.query(User).filter(
        (User.username == login_data.username) | 
        (User.email == login_data.username)
    ).first()
    
    if not user:
        raise HTTPException(status_code=401, detail="ç”¨æˆ·åæˆ–å¯†ç é”™è¯¯")
    
    if not verify_password(login_data.password, user.hashed_password):
        raise HTTPException(status_code=401, detail="ç”¨æˆ·åæˆ–å¯†ç é”™è¯¯")
    
    # ç”Ÿæˆ Token
    access_token = create_access_token(data={"sub": str(user.id)})
    
    return {
        "message": "ç™»å½•æˆåŠŸ",
        "access_token": access_token,
        "token_type": "bearer",
        "user": user.to_dict()
    }


@app.get("/api/auth/me")
def get_me(current_user: User = Depends(get_current_user_required)):
    """è·å–å½“å‰ç™»å½•ç”¨æˆ·ä¿¡æ¯"""
    return current_user.to_dict()
```

::: tip ä¸ºä»€ä¹ˆç™»å½•å¤±è´¥ä¸åŒºåˆ†"ç”¨æˆ·ä¸å­˜åœ¨"å’Œ"å¯†ç é”™è¯¯"ï¼Ÿ
è¿™æ˜¯å®‰å…¨æœ€ä½³å®è·µï¼

å¦‚æœè¿”å›"ç”¨æˆ·ä¸å­˜åœ¨"ï¼Œæ”»å‡»è€…å°±èƒ½ç¡®è®¤æŸä¸ªç”¨æˆ·åæ˜¯å¦å·²æ³¨å†Œã€‚ç»Ÿä¸€è¿”å›"ç”¨æˆ·åæˆ–å¯†ç é”™è¯¯"å¯ä»¥é˜²æ­¢ç”¨æˆ·æšä¸¾æ”»å‡»ã€‚
:::

### 9.6.1 ä¿®æ”¹å‘å¸ƒæ–‡ç«  API

ç°åœ¨ä¿®æ”¹å‘å¸ƒæ–‡ç« çš„ APIï¼Œå…³è”å½“å‰ç™»å½•ç”¨æˆ·ï¼š

```python
@app.post("/api/articles")
def create_article(
    article: ArticleCreate, 
    db: Session = Depends(get_db),
    current_user: User = Depends(get_current_user)  # å¯é€‰ç™»å½•
):
    """å‘å¸ƒæ–°æ–‡ç« """
    db_article = Article(
        title=article.title,
        summary=article.summary or article.content[:100] + "...",
        content=article.content,
        author=current_user.username if current_user else "åŒ¿å",
        created_at=datetime.now().strftime("%Y-%m-%d"),
        tags=article.tags,
        user_id=current_user.id if current_user else None
    )
    
    db.add(db_article)
    db.commit()
    db.refresh(db_article)
    
    return {
        "message": "å‘å¸ƒæˆåŠŸ",
        "article": db_article.to_dict()
    }
```

## 9.7 å‰ç«¯ï¼šç™»å½•æ³¨å†Œé¡µé¢

### 9.7.1 åˆ›å»ºè®¤è¯çŠ¶æ€ç®¡ç†

åœ¨ `frontend/app/composables/` ç›®å½•ä¸‹åˆ›å»º `useAuth.ts`ï¼š

```typescript
// frontend/app/composables/useAuth.ts
interface User {
  id: number
  username: string
  email: string
  created_at: string
  avatar: string
}

interface AuthState {
  user: User | null
  token: string | null
}

export const useAuth = () => {
  const user = useState<User | null>('auth_user', () => null)
  const token = useState<string | null>('auth_token', () => null)

  // åˆå§‹åŒ–ï¼šä» localStorage æ¢å¤ç™»å½•çŠ¶æ€
  const initAuth = () => {
    if (process.client) {
      const savedToken = localStorage.getItem('token')
      const savedUser = localStorage.getItem('user')
      if (savedToken && savedUser) {
        token.value = savedToken
        user.value = JSON.parse(savedUser)
      }
    }
  }

  // ç™»å½•
  const login = async (username: string, password: string) => {
    const response = await $fetch<{
      access_token: string
      user: User
    }>('http://localhost:8000/api/auth/login', {
      method: 'POST',
      body: { username, password }
    })

    token.value = response.access_token
    user.value = response.user

    // ä¿å­˜åˆ° localStorage
    if (process.client) {
      localStorage.setItem('token', response.access_token)
      localStorage.setItem('user', JSON.stringify(response.user))
    }

    return response
  }

  // æ³¨å†Œ
  const register = async (username: string, email: string, password: string) => {
    const response = await $fetch<{
      access_token: string
      user: User
    }>('http://localhost:8000/api/auth/register', {
      method: 'POST',
      body: { username, email, password }
    })

    token.value = response.access_token
    user.value = response.user

    // ä¿å­˜åˆ° localStorage
    if (process.client) {
      localStorage.setItem('token', response.access_token)
      localStorage.setItem('user', JSON.stringify(response.user))
    }

    return response
  }

  // é€€å‡ºç™»å½•
  const logout = () => {
    token.value = null
    user.value = null

    if (process.client) {
      localStorage.removeItem('token')
      localStorage.removeItem('user')
    }
  }

  // æ˜¯å¦å·²ç™»å½•
  const isLoggedIn = computed(() => !!token.value && !!user.value)

  return {
    user,
    token,
    isLoggedIn,
    initAuth,
    login,
    register,
    logout
  }
}
```

::: note composables æ˜¯ä»€ä¹ˆï¼Ÿ
åœ¨ Nuxt/Vue 3 ä¸­ï¼Œcomposables æ˜¯å¯å¤ç”¨çš„ç»„åˆå¼å‡½æ•°ã€‚æˆ‘ä»¬æŠŠè®¤è¯é€»è¾‘å°è£…åœ¨ `useAuth` ä¸­ï¼Œä»»ä½•ç»„ä»¶éƒ½å¯ä»¥é€šè¿‡ `const { user, login } = useAuth()` æ¥ä½¿ç”¨ã€‚
:::

### 9.7.2 åˆ›å»ºç™»å½•é¡µé¢

åœ¨ `frontend/app/pages/auth/` ç›®å½•ä¸‹åˆ›å»º `login.vue`ï¼š

```vue
<!-- frontend/app/pages/auth/login.vue -->
<template>
  <div class="auth-page">
    <div class="auth-card">
      <h1 class="auth-title">ğŸ” ç™»å½•</h1>
      <p class="auth-subtitle">æ¬¢è¿å›æ¥ï¼</p>

      <form @submit.prevent="handleLogin" class="auth-form">
        <div class="form-group">
          <label for="username">ç”¨æˆ·å / é‚®ç®±</label>
          <input
            id="username"
            v-model="form.username"
            type="text"
            placeholder="è¯·è¾“å…¥ç”¨æˆ·åæˆ–é‚®ç®±"
            required
          />
        </div>

        <div class="form-group">
          <label for="password">å¯†ç </label>
          <input
            id="password"
            v-model="form.password"
            type="password"
            placeholder="è¯·è¾“å…¥å¯†ç "
            required
          />
        </div>

        <div v-if="errorMessage" class="error-message">
          âŒ {{ errorMessage }}
        </div>

        <button type="submit" class="btn-submit" :disabled="isLoading">
          {{ isLoading ? 'ç™»å½•ä¸­...' : 'ç™»å½•' }}
        </button>
      </form>

      <p class="auth-link">
        è¿˜æ²¡æœ‰è´¦å·ï¼Ÿ
        <NuxtLink to="/auth/register">ç«‹å³æ³¨å†Œ</NuxtLink>
      </p>
    </div>
  </div>
</template>

<script setup>
const { login } = useAuth()

const form = reactive({
  username: '',
  password: ''
})

const isLoading = ref(false)
const errorMessage = ref('')

async function handleLogin() {
  errorMessage.value = ''
  isLoading.value = true

  try {
    await login(form.username, form.password)
    navigateTo('/blog')
  } catch (error) {
    errorMessage.value = error.data?.detail || 'ç™»å½•å¤±è´¥ï¼Œè¯·æ£€æŸ¥ç”¨æˆ·åå’Œå¯†ç '
  } finally {
    isLoading.value = false
  }
}
</script>

<style scoped>
.auth-page {
  min-height: 80vh;
  display: flex;
  align-items: center;
  justify-content: center;
  padding: 2rem;
}

.auth-card {
  width: 100%;
  max-width: 400px;
  background: white;
  border-radius: 1rem;
  padding: 2.5rem;
  box-shadow: 0 10px 40px rgba(0, 0, 0, 0.1);
}

.auth-title {
  font-size: 1.75rem;
  font-weight: 700;
  color: #1a202c;
  margin-bottom: 0.5rem;
  text-align: center;
}

.auth-subtitle {
  color: #6b7280;
  text-align: center;
  margin-bottom: 2rem;
}

.auth-form {
  display: flex;
  flex-direction: column;
  gap: 1.25rem;
}

.form-group {
  display: flex;
  flex-direction: column;
  gap: 0.5rem;
}

.form-group label {
  font-weight: 500;
  color: #374151;
}

.form-group input {
  padding: 0.75rem 1rem;
  border: 2px solid #e5e7eb;
  border-radius: 0.5rem;
  font-size: 1rem;
  transition: border-color 0.2s;
}

.form-group input:focus {
  outline: none;
  border-color: #667eea;
}

.error-message {
  padding: 0.75rem;
  background: #fef2f2;
  color: #dc2626;
  border-radius: 0.5rem;
  text-align: center;
  font-size: 0.875rem;
}

.btn-submit {
  padding: 0.875rem;
  background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
  color: white;
  border: none;
  border-radius: 0.5rem;
  font-size: 1rem;
  font-weight: 600;
  cursor: pointer;
  transition: transform 0.2s, box-shadow 0.2s;
}

.btn-submit:hover:not(:disabled) {
  transform: translateY(-1px);
  box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
}

.btn-submit:disabled {
  opacity: 0.6;
  cursor: not-allowed;
}

.auth-link {
  text-align: center;
  margin-top: 1.5rem;
  color: #6b7280;
}

.auth-link a {
  color: #667eea;
  text-decoration: none;
  font-weight: 500;
}

.auth-link a:hover {
  text-decoration: underline;
}
</style>
```

### 9.7.3 åˆ›å»ºæ³¨å†Œé¡µé¢

åœ¨ `frontend/app/pages/auth/` ç›®å½•ä¸‹åˆ›å»º `register.vue`ï¼š

```vue
<!-- frontend/app/pages/auth/register.vue -->
<template>
  <div class="auth-page">
    <div class="auth-card">
      <h1 class="auth-title">ğŸ‰ æ³¨å†Œ</h1>
      <p class="auth-subtitle">åŠ å…¥æˆ‘ä»¬ï¼Œå¼€å§‹ä½ çš„åšå®¢ä¹‹æ—…</p>

      <form @submit.prevent="handleRegister" class="auth-form">
        <div class="form-group">
          <label for="username">ç”¨æˆ·å</label>
          <input
            id="username"
            v-model="form.username"
            type="text"
            placeholder="3-50 ä¸ªå­—ç¬¦"
            minlength="3"
            maxlength="50"
            required
          />
        </div>

        <div class="form-group">
          <label for="email">é‚®ç®±</label>
          <input
            id="email"
            v-model="form.email"
            type="email"
            placeholder="your@email.com"
            required
          />
        </div>

        <div class="form-group">
          <label for="password">å¯†ç </label>
          <input
            id="password"
            v-model="form.password"
            type="password"
            placeholder="è‡³å°‘ 6 ä¸ªå­—ç¬¦"
            minlength="6"
            required
          />
        </div>

        <div class="form-group">
          <label for="confirmPassword">ç¡®è®¤å¯†ç </label>
          <input
            id="confirmPassword"
            v-model="form.confirmPassword"
            type="password"
            placeholder="å†æ¬¡è¾“å…¥å¯†ç "
            required
          />
        </div>

        <div v-if="errorMessage" class="error-message">
          âŒ {{ errorMessage }}
        </div>

        <button type="submit" class="btn-submit" :disabled="isLoading">
          {{ isLoading ? 'æ³¨å†Œä¸­...' : 'æ³¨å†Œ' }}
        </button>
      </form>

      <p class="auth-link">
        å·²æœ‰è´¦å·ï¼Ÿ
        <NuxtLink to="/auth/login">ç«‹å³ç™»å½•</NuxtLink>
      </p>
    </div>
  </div>
</template>

<script setup>
const { register } = useAuth()

const form = reactive({
  username: '',
  email: '',
  password: '',
  confirmPassword: ''
})

const isLoading = ref(false)
const errorMessage = ref('')

async function handleRegister() {
  errorMessage.value = ''

  // éªŒè¯ä¸¤æ¬¡å¯†ç æ˜¯å¦ä¸€è‡´
  if (form.password !== form.confirmPassword) {
    errorMessage.value = 'ä¸¤æ¬¡è¾“å…¥çš„å¯†ç ä¸ä¸€è‡´'
    return
  }

  isLoading.value = true

  try {
    await register(form.username, form.email, form.password)
    navigateTo('/blog')
  } catch (error) {
    errorMessage.value = error.data?.detail || 'æ³¨å†Œå¤±è´¥ï¼Œè¯·ç¨åé‡è¯•'
  } finally {
    isLoading.value = false
  }
}
</script>

<style scoped>
/* æ ·å¼ä¸ç™»å½•é¡µé¢ç›¸åŒ */
.auth-page {
  min-height: 80vh;
  display: flex;
  align-items: center;
  justify-content: center;
  padding: 2rem;
}

.auth-card {
  width: 100%;
  max-width: 400px;
  background: white;
  border-radius: 1rem;
  padding: 2.5rem;
  box-shadow: 0 10px 40px rgba(0, 0, 0, 0.1);
}

.auth-title {
  font-size: 1.75rem;
  font-weight: 700;
  color: #1a202c;
  margin-bottom: 0.5rem;
  text-align: center;
}

.auth-subtitle {
  color: #6b7280;
  text-align: center;
  margin-bottom: 2rem;
}

.auth-form {
  display: flex;
  flex-direction: column;
  gap: 1.25rem;
}

.form-group {
  display: flex;
  flex-direction: column;
  gap: 0.5rem;
}

.form-group label {
  font-weight: 500;
  color: #374151;
}

.form-group input {
  padding: 0.75rem 1rem;
  border: 2px solid #e5e7eb;
  border-radius: 0.5rem;
  font-size: 1rem;
  transition: border-color 0.2s;
}

.form-group input:focus {
  outline: none;
  border-color: #667eea;
}

.error-message {
  padding: 0.75rem;
  background: #fef2f2;
  color: #dc2626;
  border-radius: 0.5rem;
  text-align: center;
  font-size: 0.875rem;
}

.btn-submit {
  padding: 0.875rem;
  background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
  color: white;
  border: none;
  border-radius: 0.5rem;
  font-size: 1rem;
  font-weight: 600;
  cursor: pointer;
  transition: transform 0.2s, box-shadow 0.2s;
}

.btn-submit:hover:not(:disabled) {
  transform: translateY(-1px);
  box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
}

.btn-submit:disabled {
  opacity: 0.6;
  cursor: not-allowed;
}

.auth-link {
  text-align: center;
  margin-top: 1.5rem;
  color: #6b7280;
}

.auth-link a {
  color: #667eea;
  text-decoration: none;
  font-weight: 500;
}

.auth-link a:hover {
  text-decoration: underline;
}
</style>
```

### 9.7.4 æ›´æ–°å¯¼èˆªæ 

ä¿®æ”¹ `frontend/app/layouts/default.vue`ï¼Œæ˜¾ç¤ºç™»å½•çŠ¶æ€ï¼š

```vue
<!-- åœ¨ Header çš„ nav éƒ¨åˆ†æ·»åŠ  -->
<nav class="nav">
  <NuxtLink to="/" class="nav-link">é¦–é¡µ</NuxtLink>
  <NuxtLink to="/blog" class="nav-link">åšå®¢</NuxtLink>
  
  <!-- æ ¹æ®ç™»å½•çŠ¶æ€æ˜¾ç¤ºä¸åŒå†…å®¹ -->
  <template v-if="isLoggedIn">
    <span class="nav-user">ğŸ‘¤ {{ user?.username }}</span>
    <button @click="handleLogout" class="nav-link logout-btn">é€€å‡º</button>
  </template>
  <template v-else>
    <NuxtLink to="/auth/login" class="nav-link">ç™»å½•</NuxtLink>
    <NuxtLink to="/auth/register" class="nav-link nav-register">æ³¨å†Œ</NuxtLink>
  </template>
</nav>
```

åœ¨ `<script setup>` ä¸­ï¼š

```javascript
const { user, isLoggedIn, logout, initAuth } = useAuth()

// ç»„ä»¶æŒ‚è½½æ—¶åˆå§‹åŒ–è®¤è¯çŠ¶æ€
onMounted(() => {
  initAuth()
})

function handleLogout() {
  logout()
  navigateTo('/')
}
```

æ·»åŠ æ ·å¼ï¼š

```css
.nav-user {
  color: rgba(255, 255, 255, 0.9);
  font-weight: 500;
}

.logout-btn {
  background: none;
  border: none;
  cursor: pointer;
  font-size: inherit;
}

.nav-register {
  background: rgba(255, 255, 255, 0.2);
  padding: 0.5rem 1rem;
  border-radius: 0.5rem;
}
```

## 9.8 æµ‹è¯•ç”¨æˆ·ç³»ç»Ÿ

### 9.8.1 æµ‹è¯•æµç¨‹

1. è®¿é—® `http://localhost:3000/auth/register`
2. å¡«å†™ç”¨æˆ·åã€é‚®ç®±ã€å¯†ç ï¼Œç‚¹å‡»æ³¨å†Œ
3. æ³¨å†ŒæˆåŠŸåè‡ªåŠ¨è·³è½¬åˆ°åšå®¢åˆ—è¡¨
4. å¯¼èˆªæ æ˜¾ç¤ºç”¨æˆ·å
5. ç‚¹å‡»"é€€å‡º"ï¼Œæ¢å¤ä¸º"ç™»å½•/æ³¨å†Œ"æŒ‰é’®
6. è®¿é—® `http://localhost:3000/auth/login`
7. ç”¨åˆšæ‰æ³¨å†Œçš„è´¦å·ç™»å½•

::: important ğŸ‰ æ­å–œï¼ç”¨æˆ·ç³»ç»Ÿä¸Šçº¿ï¼
ç°åœ¨ä½ çš„åšå®¢ï¼š
- âœ… æ”¯æŒç”¨æˆ·æ³¨å†Œ
- âœ… æ”¯æŒç”¨æˆ·ç™»å½•
- âœ… è®°ä½ç™»å½•çŠ¶æ€
- âœ… æ˜¾ç¤ºå½“å‰ç”¨æˆ·
- âœ… æ–‡ç« å…³è”ä½œè€…

ä½ çš„åšå®¢æ­£åœ¨å˜æˆä¸€ä¸ªçœŸæ­£çš„ç¤¾åŒºï¼
:::

## 9.9 å°ç»“

::: note æœ¬ç« å›é¡¾
æœ¬ç« æˆ‘ä»¬å®Œæˆäº†ï¼š
- ç†è§£äº†è®¤è¯ä¸æˆæƒçš„åŒºåˆ«
- å­¦ä¹ äº†å¯†ç å®‰å…¨å’Œ bcrypt å“ˆå¸Œ
- äº†è§£äº† JWT çš„åŸç†å’Œç”¨æ³•
- å®ç°äº†ç”¨æˆ·æ³¨å†Œå’Œç™»å½• API
- åˆ›å»ºäº†å‰ç«¯ç™»å½•æ³¨å†Œé¡µé¢
- å®ç°äº†ç™»å½•çŠ¶æ€ç®¡ç†
:::

::: tip åŠ¨æ‰‹ç»ƒä¹ 
è¯•ç€æ‰©å±•ä¸€ä¸‹ï¼š

1. **è®°ä½æˆ‘åŠŸèƒ½**ï¼šç™»å½•æ—¶æ·»åŠ "è®°ä½æˆ‘"é€‰é¡¹ï¼Œå»¶é•¿ Token æœ‰æ•ˆæœŸ
2. **ä¿®æ”¹å¯†ç **ï¼šæ·»åŠ ä¿®æ”¹å¯†ç åŠŸèƒ½ï¼ˆéœ€è¦éªŒè¯æ—§å¯†ç ï¼‰
3. **å¤´åƒä¸Šä¼ **ï¼šè®©ç”¨æˆ·å¯ä»¥ä¸Šä¼ è‡ªå·±çš„å¤´åƒ
4. **é‚®ç®±éªŒè¯**ï¼šæ³¨å†Œåå‘é€éªŒè¯é‚®ä»¶ï¼ˆè¿›é˜¶ï¼‰

è¿™äº›ç»ƒä¹ èƒ½å¸®ä½ æ›´æ·±å…¥ç†è§£ç”¨æˆ·ç³»ç»Ÿï¼
:::

::: caution å®‰å…¨æé†’
æœ¬ç« çš„å®ç°é€‚åˆå­¦ä¹ ï¼Œä½†åœ¨ç”Ÿäº§ç¯å¢ƒä¸­è¿˜éœ€è¦ï¼š

- ğŸ” ä½¿ç”¨ HTTPS åŠ å¯†ä¼ è¾“
- ğŸ”‘ æŠŠ SECRET_KEY æ”¾åˆ°ç¯å¢ƒå˜é‡
- â° å®ç° Token åˆ·æ–°æœºåˆ¶
- ğŸš« æ·»åŠ ç™»å½•å¤±è´¥æ¬¡æ•°é™åˆ¶
- ğŸ“ è®°å½•ç™»å½•æ—¥å¿—
:::

::: info ä¸‹ä¸€ç« é¢„å‘Š
ç”¨æˆ·ç³»ç»Ÿæœ‰äº†ï¼Œä½†è¿˜å·®ç‚¹ä»€ä¹ˆâ€”â€”ç™»å½•ååº”è¯¥æœ‰è‡ªå·±çš„**ä¸ªäººä¸­å¿ƒ**ï¼Œå¯ä»¥ç®¡ç†è‡ªå·±å‘å¸ƒçš„æ–‡ç« ã€‚ä¸‹ä¸€ç« æˆ‘ä»¬æ¥å®ç°ï¼š

- ğŸ‘¤ ä¸ªäººä¸­å¿ƒé¡µé¢
- ğŸ“ æˆ‘çš„æ–‡ç« åˆ—è¡¨
- ğŸ›¡ï¸ è·¯ç”±å®ˆå«ï¼ˆæœªç™»å½•è‡ªåŠ¨è·³è½¬ï¼‰
- âœï¸ ç¼–è¾‘å’Œåˆ é™¤è‡ªå·±çš„æ–‡ç« 

å‡†å¤‡å¥½æ‰“é€ ä¸ªäººç©ºé—´äº†å—ï¼Ÿ
:::
